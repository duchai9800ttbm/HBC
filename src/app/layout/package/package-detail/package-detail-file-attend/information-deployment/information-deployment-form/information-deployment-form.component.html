<form [formGroup]="planForm" *ngIf="planForm" class="position-relative">
    <div class="title-list-package d-flex flex-wrap align-items-center status-filter">
        <div class="mr-auto d-flex align-items-end list-package mt-2 mb-2">
            <div class="d-flex justify-content-start h-40">
                <div class="rule mr-2">
                </div>
                <div class="center-parent pl-3 mr-4 live-form-title">
                    <a [routerLink]='["../"]'>
                        <img width="12" height="12" class="pointer not-outline" src="assets\images\nghia.png">
                    </a>
                    <div class="text-uppercase ml-3">bảng phân công tiến độ (tender preparation planning assignment)</div>
                </div>
            </div>
        </div>
        <div>
            <div class="btn-toolbar mt-2 mb-2">
                <!-- <button class="btn btn-primary ml-2">
              Import dữ liệu theo mẫu
          </button> -->
                <button class="btn btn-primary ml-1" (click)="changeRouterAction('edit')" *ngIf="routerAction == 'view' && packageInfo?.stageStatus.id != bidStatus.DaGuiPhanCongTienDo">Sửa</button>
                <button class="btn btn-primary ml-1" (click)="submitForm(true)" *ngIf="planForm?.get('isDraftVersion').value && routerAction != 'view'">
                    Lưu nháp
                </button>
                <button class="btn btn-primary ml-1" *ngIf="routerAction != 'view'" (click)="submitForm(false)">
                    Lưu
                </button>
                <button class="btn btn-secondary ml-1" *ngIf="routerAction != 'view'" routerLink="../">
                    Hủy
                </button>
                <button class="btn btn-primary ml-1" (click)="refesh()">
                    <i class="fa fa-refresh" aria-hidden="true"></i>
                </button>
            </div>
        </div>
    </div>
    <div class="pl-3">
        <div class="header m-0">
            <div class="row">
                <div class="col-md-6 pl-0 header-bid-info">
                    <div class="">
                        <strong>Công trình (Project):</strong>
                    </div>
                    <div class="">{{packageInfo?.projectName}}</div>
                </div>
                <div class="col-md-3 pl-0">
                    <div class="">
                        <strong>Người lập (Prepare by): </strong>{{tenderPlan?.createdEmployee?.employeeName}}</div>
                    <div class=""></div>
                </div>
                <div class="col-md-3 pl-0">
                    <div class="">
                        <strong>Người duyệt (Approved by): </strong>{{tenderPlan?.approvedEmployee?.employeeName}}</div>
                    <div class=""></div>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-md-6 pl-0 header-bid-info">
                    <div class="">
                        <strong>Địa điểm (Location):</strong>
                    </div>
                    <div class="">{{packageInfo?.place}}</div>
                </div>
                <div class="col-md-3 pl-0">
                    <div class="">
                        <strong>Ngày lập (Date): </strong>{{tenderPlan?.createDate * 1000 | date: 'dd/MM/yyyy' : '+0000'}}</div>
                    <div class=""></div>
                </div>
                <div class="col-md-3 pl-0">
                    <div class="">
                        <strong>Ngày duyệt (Date): </strong>{{tenderPlan?.approvedDate * 1000 | date: 'dd/MM/yyyy' : '+0000'}}</div>
                    <div class=""></div>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-md-6 pl-0 header-bid-info">
                    <div class="">
                        <strong>Gói thầu (Package):</strong>
                    </div>
                    <div class="">{{packageInfo?.opportunityName}}</div>
                </div>
                <div class="col-md-3 pl-0">
                    <button class="btn btn-primary btn-sign position-absolute" *ngIf="!planForm.get('isSignedByPreparedPerson').value" (click)="clickSignPrepare()">Xác nhận ký</button>
                    <button class="btn btn-primary btn-sign position-absolute" *ngIf="planForm.get('isSignedByPreparedPerson').value">
                        <i class="fa fa-check icon-check" aria-hidden="true"></i> Đã ký
                    </button>
                </div>
                <div class="col-md-3 pl-0">
                    <button class="btn btn-primary btn-sign position-absolute"
                    [disabled]="!planForm.get('isSignedByPreparedPerson').value || routerAction !== 'view'" 
                    [class.not-allow]="!planForm.get('isSignedByPreparedPerson').value || routerAction !== 'view'"
                    *ngIf="!planForm.get('isSignedByApprovalPerson').value" (click)="clickSignApproved()">Xác nhận ký</button>
                    <button class="btn btn-primary btn-sign position-absolute" *ngIf="planForm.get('isSignedByApprovalPerson').value">
                        <i class="fa fa-check icon-check" aria-hidden="true"></i> Đã ký
                    </button>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-md-6 pl-0 header-bid-info">
                    <div class="">
                        <strong>Chủ đầu tư (Employer):</strong>
                    </div>
                    <div class=""></div>
                </div>
                <div class="col-md-6">
                    <div class="col-md-4">
                        <strong></strong>
                    </div>
                    <div class="col-md-8"></div>
                </div>
            </div>
        </div>
        <div class="view-readonly" *ngIf="routerAction == 'view'"></div>
        <div class="mt-3">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Tên tài liệu</th>
                        <th colspan="5">
                            <input class="form-control" formControlName="projectInformation">
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td rowspan="4">KEY PERSONNEL</td>
                        <td>Project Director</td>
                        <td>
                            <span class="custom-dropdown w-100 b-dropdown-no-border">
                                <select class="form-control" (change)="changeDirector($event.target.value, 0)" formControlName="projectDirectorEmployeeId">
                                    <option [ngValue]="null">--Chọn--</option>
                                    <option *ngFor="let user of userList" [value]="user.employeeId">{{user.employeeName}}</option>
                                </select>
                            </span>
                        </td>
                        <td class="mw-12">
                            <a>{{mailPersonnel[0]}}</a>
                        </td>
                        <td>Start</td>
                        <td class="mw-12">
                            <!-- <kendo-datepicker class="form-control b-datepicker-no-border"></kendo-datepicker> -->
                            {{getDateStr(packageInfo?.startTrackingDate * 1000)}}
                        </td>
                    </tr>
                    <tr>
                        <td>Tender Dept</td>
                        <td>
                            <span class="custom-dropdown w-100 b-dropdown-no-border">
                                <select class="form-control" (change)="changeDirector($event.target.value, 1)" formControlName="tenderDepartmentEmployeeId">
                                    <option [ngValue]="null">--Chọn--</option>
                                    <option *ngFor="let user of userList" [value]="user.employeeId">{{user.employeeName}}</option>
                                </select>
                            </span>
                        </td>
                        <td>
                            <a>{{mailPersonnel[1]}}</a>
                        </td>
                        <td>Tender Duration</td>
                        <td>
                            <!-- <kendo-datepicker class="form-control b-datepicker-no-border"></kendo-datepicker> -->
                            {{(packageInfo?.submissionDate - packageInfo?.startTrackingDate) / (60 * 60 * 24)}} days
                        </td>
                    </tr>
                    <tr>
                        <td>Technical Dept</td>
                        <td>
                            <span class="custom-dropdown w-100 b-dropdown-no-border">
                                <select class="form-control" (change)="changeDirector($event.target.value, 2)" formControlName="technicalDepartmentEmployeeId">
                                    <option [ngValue]="null">--Chọn--</option>
                                    <option *ngFor="let user of userList" [value]="user.employeeId">{{user.employeeName}}</option>
                                </select>
                            </span>
                        </td>
                        <td>
                            <a>{{mailPersonnel[2]}}</a>
                        </td>
                        <td>Query's Deadline</td>
                        <td>
                            <!-- <kendo-datepicker class="form-control b-datepicker-no-border"></kendo-datepicker> -->
                            {{packageInfo?.submissionDate ? getDateStr(packageInfo?.submissionDate * 1000 - (1000 * 60 * 60 * 24 * 7)) : ''}}
                        </td>
                    </tr>
                    <tr>
                        <td>BIM Dept</td>
                        <td>
                            <span class="custom-dropdown w-100 b-dropdown-no-border">
                                <select class="form-control" (change)="changeDirector($event.target.value, 3)" formControlName="bimDepartmentEmployeeId">
                                    <option [ngValue]="null">--Chọn--</option>
                                    <option *ngFor="let user of userList" [value]="user.employeeId">{{user.employeeName}}</option>
                                </select>
                            </span>
                        </td>
                        <td>
                            <a>{{mailPersonnel[3]}}</a>
                        </td>
                        <td>Finish</td>
                        <td>
                            <!-- <kendo-datepicker class="form-control b-datepicker-no-border"></kendo-datepicker> -->
                            {{getDateStr(packageInfo?.submissionDate * 1000)}}
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="row">
            <div class="col-md-9 pr-0">
                <table class="table table-bordered tbl-data-gantt">
                    <thead class="tbl-header-bg-color">
                        <tr>
                            <th class="text-center align-middle">STT</th>
                            <th class="text-center align-middle w-work">Công việc</th>
                            <th class="text-center align-middle text-nowrap w-work">Mô tả</th>
                            <th class="text-center align-middle">Phân công cho</th>
                            <th class="text-center align-middle">Hoàn thành</th>
                            <th class="text-center align-middle col-datetime">Ngày bắt đầu</th>
                            <th class="text-center align-middle col-datetime">Ngày kết thúc</th>
                            <th class="text-center align-middle">Tổng thời gian</th>
                        </tr>
                    </thead>
                    <tbody formArrayName="tasks">
                        <tr *ngFor="let data of tasksFA.controls; let i = index" [formGroupName]="i" [class.b-k-alt]="i % 2 != 0">
                            <td class="text-center">{{data.get('itemNo').value}}</td>
                            <td>{{data.get('itemName').value}}</td>
                            <!-- <td>{{data.get('itemDesc').value}}</td> -->
                            <td class="p-0 position-relative">
                                <textarea class="form-control b-textarea h-100" formControlName="itemDesc"></textarea>
                                <span *ngIf="!data.get('itemDesc').value" class="fake-placeholder">Nhập text</span>
                            </td>
                            <td class="pl-0" *ngIf="data.get('itemId').value !== 6">
                                <span class="custom-dropdown w-100 b-dropdown-no-border">
                                    <select class="form-control" formControlName="whoIsInChargeId">
                                        <option [ngValue]="null">--Chọn--</option>
                                        <option *ngFor="let user of userList" [value]="user.employeeId">{{user.employeeName}}</option>
                                    </select>
                                </span>
                            </td>
                            <td *ngIf="data.get('itemId').value === 6">
                                <ng-select class="w-100" [items]="userList" placeholder="--Chọn--" typeToSearchText="Nhập tên" clearAllText="Xóa tất cả"
                                    [hideSelected]="true" multiple="true" bindLabel="employeeName"
                                    formControlName="whoIsInChargeId" style="outline: none">
                                </ng-select>
                            </td>
                            <td class="text-center">
                                <label class="custom-control custom-checkbox z-ontop">
                                    <input type="checkbox" (click)="checkFinishTenderPlanItem(data.get('itemId').value)" class="custom-control-input input-checkbox"
                                        [attr.disabled]="packageInfo?.stageStatus.id != bidStatus.DaGuiPhanCongTienDo ? '' : null"
                                        formControlName="isFinish">
                                    <span class="custom-control-indicator"></span>
                                </label>
                            </td>
                            <td class="pl-0">
                                <kendo-datepicker (valueChange)="calculateTotalTime(i)" [max]="data.get('finishDate').value" formControlName="startDate" class="form-control b-datepicker-no-border b-datepicker-ic"></kendo-datepicker>
                            </td>
                            <td class="pl-0">
                                <kendo-datepicker (valueChange)="calculateTotalTime(i)" [min]="data.get('startDate').value" formControlName="finishDate" class="form-control b-datepicker-no-border b-datepicker-ic"></kendo-datepicker>
                            </td>
                            <td class="text-center">
                                {{data.get('totalTime') ? data.get('totalTime').value : ''}}
                                <!-- {{getItemDuration(data.get('startDate').value, data.get('finishDate').value)}} -->
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="col-md-3 pl-0">
                <div #ganttChart></div>
            </div>
        </div>
    </div>
    <kendo-dialog [width]="550" *ngIf="isShowChanges">
        <div>
            <div class="dialog-header mt-2">
                <h3 class="text-center text-uppercase color-black">Cập nhật liveform</h3>
                <span class="ic-close pointer" (click)="closeShowChanges()">
                    <img src="assets/images/ic-close.svg">
                </span>
            </div>
            <div class="text-center">
                Bạn đã cập nhật những gì trong lần sửa này?
            </div>
            <div class="dialog-body">
                <div class="w-100 mt-4">
                    <div class="pr-1 pl-1">
                        <textarea formControlName="updatedDesc" class="form-control" rows="3"></textarea>
                    </div>
                </div>
            </div>
            <div class="mt-4 text-center mb-2">
                <button class="btn b-btn btn-primary" (click)="saveChangesLiveForm()">OK</button>
            </div>
        </div>
    </kendo-dialog>
</form>
<ngx-spinner bdColor="rgba(51, 51, 51, 0.7)" size="medium" color="#fff" type="ball-clip-rotate-multiple"></ngx-spinner>